<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Marine Design Node - Pro Edition</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6557224818632411"
     crossorigin="anonymous"></script>
    <style>
        :root { --header-h: 45px; --side-w: 220px; --ai-h: 300px; --accent: #e67e22; }
        body, html { height: 100vh; width: 100vw; margin: 0; font-family: sans-serif; overflow: hidden; background: #1a1a1a; color: #eee; }
        
        .wrapper { display: grid; grid-template-columns: var(--side-w) 1fr 1fr; grid-template-rows: var(--header-h) 1fr var(--ai-h); height: 100vh; }
        header { grid-column: 1 / 4; background: #2c3e50; display: flex; align-items: center; padding: 0 15px; gap: 8px; border-bottom: 1px solid #444; z-index: 100; }
        
        /* „Çµ„Ç§„Éâ„Éê„ÉºÊßãÈÄ†„ÅÆÊúÄÈÅ©Âåñ */
        aside { grid-row: 2 / 4; background: #252526; border-right: 1px solid #444; display: flex; flex-direction: column; min-height: 0; }
        .search-box { padding: 10px; background: #333; border-bottom: 1px solid #444; flex-shrink: 0; }
        #search-input { width: 100%; background: #1e1e1e; border: 1px solid #555; color: #fff; padding: 6px; border-radius: 3px; font-size: 12px; box-sizing: border-box; }
        #note-list { list-style: none; padding: 0; margin: 0; overflow-y: auto; flex: 1; }
        #note-list li { padding: 12px; border-bottom: 1px solid #333; cursor: pointer; font-size: 12px; color: #aaa; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        #note-list li:hover { background: #2a2d2e; }
        #note-list li.active { background: #37373d; border-left: 4px solid var(--accent); color: #fff; }

        .pane { display: flex; flex-direction: column; border-right: 1px solid #444; background: #1e1e1e; min-height: 0; }
        .pane-header { background: #333; padding: 6px 12px; font-size: 11px; font-weight: bold; color: #aaa; display: flex; justify-content: space-between; flex-shrink: 0; }
        
        textarea { flex: 1; background: #1e1e1e; color: #d4d4d4; border: none; padding: 15px; font-family: monospace; font-size: 14px; outline: none; resize: none; line-height: 1.6; }
        #preview { flex: 1; padding: 25px; overflow-y: auto; background: #fff; color: #333; }
        #preview img { max-width: 100%; height: auto; border: 1px solid #ddd; margin: 10px 0; }

        footer { grid-column: 2 / 4; display: grid; grid-template-columns: 1fr 340px; background: #252526; border-top: 2px solid #444; overflow: hidden; min-height: 0; }
        
        .ai-box { display: flex; flex-direction: column; border-right: 1px solid #444; min-height: 0; }
        #ai-output { flex: 1; padding: 10px; overflow-y: auto; font-size: 13px; color: #ccc; background: #1e1e1e; }
        .input-group { flex-shrink: 0; display: flex; padding: 10px; gap: 5px; background: #252526; border-top: 1px solid #333; }
        .input-group input { flex: 1; background: #3c3c3c; border: 1px solid #555; color: white; padding: 8px; border-radius: 3px; }

        .ads-box { display: flex; flex-direction: column; background: #2d2d2d; min-height: 0; }
        .ads-content { flex: 1; display: flex; flex-direction: column; align-items: center; padding: 10px; overflow-y: auto; }
        .ads-fixed-frame { width: 300px; height: 250px; background: #333; margin-top: 5px; flex-shrink: 0; }
        
        button { background: var(--accent); color: white; border: none; padding: 6px 12px; border-radius: 3px; cursor: pointer; font-size: 12px; font-weight: bold; }
        .btn-sub { background: #555; }
        .btn-green { background: #27ae60; }
        
        .hide-sidebar { grid-template-columns: 0px 1fr 1fr !important; }
        .reader-mode { grid-template-columns: 0px 0px 1fr !important; grid-template-rows: var(--header-h) 1fr 0px !important; }
    </style>
</head>
<body>

<div class="wrapper" id="main-layout">
    <header>
        <button class="btn-sub" onclick="toggleSidebar()">üìÅ „Éï„Ç©„É´„ÉÄ</button>
        <button class="btn-sub" onclick="toggleReader()">üìñ Ë™≠Êõ∏</button>
        <button class="btn-sub" onclick="createNewNote()">Ôºã Êñ∞Ë¶è</button>
        <button class="btn-sub" onclick="document.getElementById('file-input').click()">üìÇ ‰∏ÄÊã¨Ë™≠Ëæº</button>
        <button class="btn-green" onclick="exportNote()">üíæ ‰øùÂ≠ò(.md)</button>
        <input type="file" id="file-input" style="display:none;" accept=".md" multiple onchange="importMultipleNotes(this)">
    </header>

    <aside id="sidebar">
        <div class="search-box">
            <input type="text" id="search-input" placeholder="„Éé„Éº„Éà„ÇíÊ§úÁ¥¢..." oninput="renderList()">
        </div>
        <ul id="note-list"></ul>
    </aside>

    <div class="pane">
        <div class="pane-header">EDITOR</div>
        <textarea id="editor" spellcheck="false" oninput="debouncedUpdate()"></textarea>
    </div>

    <div class="pane">
        <div class="pane-header">PREVIEW</div>
        <div id="preview"></div>
    </div>

    <footer>
        <div class="ai-box">
            <div class="pane-header">AI ASSISTANT <button id="apply-btn" style="display:none; height:18px; padding:0 8px; font-size:10px; background:#27ae60;" onclick="applyToNote()">„Éé„Éº„Éà„Å´ËøΩË®ò</button></div>
            <div id="ai-output"></div>
            <div class="input-group">
                <input type="text" id="ai-input" placeholder="Ë®≠Ë®à„ÅÆÁõ∏Ë´á..." onkeypress="if(event.key==='Enter') askAI()">
                <button onclick="askAI()">ÈÄÅ‰ø°</button>
            </div>
        </div>
        
        <div class="ads-box">
            <div class="pane-header">SPONSORED</div>
            <div class="ads-content">
                <div style="font-size:9px; color:#666;">ADVERTISEMENT</div>
                <div class="ads-fixed-frame">
                    <ins class="adsbygoogle"
                         style="display:inline-block;width:300px;height:250px"
                         data-ad-client="ca-pub-6557224818632411"
                         data-ad-slot="1240580693"></ins>
                    <script>(adsbygoogle = window.adsbygoogle || []).push({});</script>
                </div>
                <div style="margin-top:10px; font-size:10px; color:#888; width:300px; line-height:1.4;">
                    <strong>MDmemo</strong><br>
                    Markdown & KaTeX & DB‰øùÂ≠òÂØæÂøú„ÄÇ
                </div>
            </div>
        </div>
    </footer>
</div>

<script>
    const API_KEY = 'AIzaSyCPq0wzFccDr5Tx_hcuFf_QWW0Nfz6rrfo';
    let db, notes = [], currentNoteId = null, lastAIResponse = "";
    const katexConfig = { delimiters: [{left: "$$", right: "$$", display: true}, {left: "$", right: "$", display: false}], throwOnError: false };
    const editor = document.getElementById('editor');
    const preview = document.getElementById('preview');

    const req = indexedDB.open("MarineDB_StoredImages", 2);
    req.onupgradeneeded = (e) => {
        const d = e.target.result;
        if (!d.objectStoreNames.contains("notes")) d.createObjectStore("notes", { keyPath: "id" });
        if (!d.objectStoreNames.contains("images")) d.createObjectStore("images", { keyPath: "id" });
    };
    req.onsuccess = (e) => { db = e.target.result; loadNotes(); };

    function loadNotes() {
        db.transaction("notes").objectStore("notes").getAll().onsuccess = (e) => {
            notes = e.target.result.sort((a,b) => b.id - a.id);
            if (notes.length === 0) createNewNote("ÂàùÊúü„Éé„Éº„Éà", "# ËàπËà∂Ë®≠Ë®àÈñãÂßã");
            else { currentNoteId = notes[0].id; showNote(); }
        };
    }

    function toggleSidebar() { document.getElementById('main-layout').classList.toggle('hide-sidebar'); }
    function toggleReader() { document.getElementById('main-layout').classList.toggle('reader-mode'); }
    function showNote() { const n = notes.find(x => x.id === currentNoteId); if (n) { editor.value = n.content; updatePreview(); } }

    let debounceTimer;
    function debouncedUpdate() { clearTimeout(debounceTimer); debounceTimer = setTimeout(updatePreview, 300); }

    async function updatePreview() {
        let content = editor.value;
        const imgRegex = /!\[img\]\((img-\d+)\)/g;
        let matches = [...content.matchAll(imgRegex)];
        
        for (const match of matches) {
            const imgId = match[1];
            const imgObj = await getFromDB("images", imgId);
            if (imgObj) {
                const url = URL.createObjectURL(imgObj.data);
                content = content.replace(`(${imgId})`, `(${url})`);
            }
        }
        preview.innerHTML = marked.parse(content);
        renderMathInElement(preview, katexConfig);
        const n = notes.find(x => x.id === currentNoteId);
        if (n) { 
            n.content = editor.value; 
            n.title = n.content.split('\n')[0].replace(/[#*`]/g,'').trim() || "ÁÑ°È°å";
            saveToDB("notes", n); 
            renderList(); 
        }
    }

    function getFromDB(s, id) { return new Promise(res => { const r = db.transaction(s).objectStore(s).get(id); r.onsuccess = () => res(r.result); }); }
    function saveToDB(s, obj) { db.transaction(s, "readwrite").objectStore(s).put(obj); }

    // Ê§úÁ¥¢Ê©üËÉΩ‰ªò„Åç„É™„Çπ„ÉàÊèèÁîª
    function renderList() {
        const query = document.getElementById('search-input').value.toLowerCase();
        const l = document.getElementById('note-list'); 
        l.innerHTML = '';
        
        const filtered = notes.filter(n => n.title.toLowerCase().includes(query) || n.content.toLowerCase().includes(query));
        
        filtered.forEach(n => {
            const li = document.createElement('li');
            li.className = (n.id === currentNoteId ? 'active' : '');
            li.innerText = n.title;
            li.onclick = () => { currentNoteId = n.id; showNote(); };
            l.appendChild(li);
        });
    }

    function createNewNote(t="Êñ∞Ë¶è", c="# ") {
        const n = { id: Date.now(), title: t, content: c };
        notes.unshift(n); currentNoteId = n.id; saveToDB("notes", n); showNote();
    }

    // ‰∏ÄÊã¨„Ç§„É≥„Éù„Éº„Éà
    async function importMultipleNotes(input) {
        const files = Array.from(input.files);
        for (const file of files) {
            await new Promise(resolve => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const n = { id: Date.now() + Math.random(), title: file.name.replace('.md',''), content: e.target.result };
                    notes.unshift(n); saveToDB("notes", n); resolve();
                };
                reader.readAsText(file);
            });
        }
        currentNoteId = notes[0].id;
        showNote(); renderList();
        input.value = "";
    }

    editor.addEventListener('paste', async (e) => {
        for (let item of e.clipboardData.items) {
            if (item.type.includes('image')) {
                const blob = item.getAsFile();
                const imgId = "img-" + Date.now();
                saveToDB("images", { id: imgId, data: blob });
                editor.setRangeText(`\n![img](${imgId})\n`, editor.selectionStart, editor.selectionEnd, 'end');
                updatePreview(); e.preventDefault();
            }
        }
    });

    async function askAI() {
        const input = document.getElementById('ai-input'), out = document.getElementById('ai-output');
        if(!input.value) return; out.innerText = "ÊÄùËÄÉ‰∏≠...";
        try {
            const resp = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-3-flash-preview-001:generateContent?key=${API_KEY}`, {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ contents: [{ parts: [{ text: `ËàπËà∂Ë®≠Ë®àÂä©Êâã„ÄÇ„Éé„Éº„ÉàÔºö\n${editor.value}\nË≥™ÂïèÔºö${input.value}` }] }] })
            });
            const data = await resp.json();
            lastAIResponse = data.candidates[0].content.parts[0].text;
            out.innerHTML = marked.parse(lastAIResponse);
            renderMathInElement(out, katexConfig);
            document.getElementById('apply-btn').style.display = "inline";
            input.value = '';
        } catch(e) { out.innerText = "Error"; }
    }

    function applyToNote() {
        editor.setRangeText(`\n\n---\n**AI (${new Date().toLocaleTimeString()}):**\n\n${lastAIResponse}\n`, editor.selectionStart, editor.selectionEnd, 'end');
        updatePreview(); document.getElementById('apply-btn').style.display = "none";
    }

    function exportNote() {
        const n = notes.find(x => x.id === currentNoteId);
        const b = new Blob([editor.value], {type:'text/markdown'});
        const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = `${n.title}.md`; a.click();
    }
</script>
</body>
</html>