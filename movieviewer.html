<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>攻略同期ツール：ズーム機能付き</title>
    <style>
        body { display: flex; flex-direction: column; height: 100vh; margin: 0; font-family: sans-serif; background: #121212; color: #fff; overflow: hidden; }
        #header { padding: 8px; background: #222; display: flex; gap: 8px; border-bottom: 2px solid #333; align-items: flex-end; flex-wrap: wrap; }
        .input-group { display: flex; flex-direction: column; gap: 2px; }
        label { font-size: 9px; color: #aaa; }
        input[type="text"] { padding: 4px; border-radius: 4px; border: 1px solid #444; background: #333; color: #fff; width: 120px; font-size: 11px; }
        
        /* ズームコントロール */
        .zoom-ctrl { display: flex; align-items: center; gap: 5px; background: #444; padding: 2px 8px; border-radius: 4px; font-size: 11px; }
        input[type="range"] { width: 80px; cursor: pointer; }

        #main-container { display: flex; flex: 1; overflow: hidden; position: relative; }
        
        /* 動画セクション（ここがズームの"窓"になる） */
        #video-viewport { 
            flex: 1; 
            position: relative; 
            background: #000; 
            overflow: hidden; /* はみ出た部分を隠す */
            display: flex;
            flex-direction: column;
        }

        /* YouTubeプレイヤー自体を動かす */
        #player-container {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            transform-origin: 0 0; /* 左上を起点に拡大 */
        }

        #resizer { width: 8px; cursor: col-resize; background: #333; z-index: 10; }
        #sheet-section { width: 400px; background: #fff; }
        iframe { width: 100%; height: 100%; border: none; }

        /* 同期通知エリア（動画の上に浮かせる） */
        #sync-overlay { 
            position: absolute; bottom: 0; left: 0; right: 0;
            background: rgba(0, 0, 0, 0.85); padding: 10px; 
            border-top: 3px solid #d81b60; z-index: 5;
        }
        .time-badge { color: #ffeb3b; font-family: monospace; font-size: 20px; font-weight: bold; }
        .gimmick-title { font-size: 20px; font-weight: bold; margin-left: 10px; }
        .switch-yellow { color: #ffeb3b !important; }
        
        #skill-display { display: flex; gap: 5px; margin-top: 5px; overflow-x: auto; }
        .job-card { background: #333; padding: 3px; border-radius: 4px; text-align: center; min-width: 45px; }
        .job-name { font-size: 8px; color: #4fc3f7; display: block; }
        .skill-icon { width: 28px; height: 28px; }

        #status { font-size: 9px; color: #666; position: absolute; top: 5px; right: 10px; }
    </style>
</head>
<body>

<div id="header">
    <div class="input-group"><label>URL</label><input type="text" id="sheetUrl"></div>
    <div class="input-group"><label>YT ID</label><input type="text" id="videoId"></div>
    <div class="input-group"><label>開始秒</label><input type="text" id="startTimeInput" value="0:00"></div>
    
    <div class="zoom-ctrl">
        <label>ズーム</label>
        <input type="range" id="zoomRange" min="1" max="4" step="0.1" value="1" oninput="updateZoom()">
        <label>X</label>
        <input type="range" id="posX" min="-200" max="200" step="1" value="0" oninput="updateZoom()">
        <label>Y</label>
        <input type="range" id="posY" min="-200" max="200" step="1" value="0" oninput="updateZoom()">
        <button onclick="resetZoom()" style="font-size:9px;">Reset</button>
    </div>
    
    <button onclick="initApp()" style="background:#d81b60; color:#fff; border:none; padding:4px 10px; cursor:pointer;">同期開始</button>
</div>

<div id="main-container">
    <div id="video-viewport">
        <div id="player-container">
            <div id="player"></div>
        </div>

        <div id="sync-overlay">
            <div style="display:flex; align-items:center;">
                <span id="time-text" class="time-badge">0:00</span>
                <span id="gimmick-text" class="gimmick-title">待機中</span>
            </div>
            <div id="skill-display"></div>
        </div>
        <div id="status">Ready</div>
    </div>

    <div id="resizer"></div>
    <div id="sheet-section"><iframe id="sheetFrame"></iframe></div>
</div>

<script>
    let player, offsetSec = 0, timer, timeline = [], jobs = [], icons = [];

    // ズーム更新処理
    function updateZoom() {
        const zoom = document.getElementById('zoomRange').value;
        const x = document.getElementById('posX').value;
        const y = document.getElementById('posY').value;
        const container = document.getElementById('player-container');
        
        // CSSのtransformで拡大と移動を制御
        container.style.transform = `scale(${zoom}) translate(${x}%, ${y}%)`;
    }

    function resetZoom() {
        document.getElementById('zoomRange').value = 1;
        document.getElementById('posX').value = 0;
        document.getElementById('posY').value = 0;
        updateZoom();
    }

    // --- 以下、以前の同期ロジックを統合 ---
    const resizer = document.getElementById('resizer'), sheetSide = document.getElementById('sheet-section');
    let dragging = false;
    resizer.addEventListener('mousedown', () => dragging = true);
    window.addEventListener('mousemove', (e) => { if(dragging) sheetSide.style.width = (window.innerWidth - e.clientX) + 'px'; });
    window.addEventListener('mouseup', () => dragging = false);

    function onYouTubeIframeAPIReady() {
        player = new YT.Player('player', { height: '100%', width: '100%', videoId: '', 
            playerVars: { 'rel': 0, 'modestbranding': 1 },
            events: { 'onStateChange': (e) => { if(e.data == 1) startLoop(); else clearInterval(timer); } } 
        });
    }

    async function initApp() {
        const url = document.getElementById('sheetUrl').value.trim();
        const vid = document.getElementById('videoId').value.trim();
        if(!url || !vid) return;
        document.getElementById('sheetFrame').src = url;
        player.loadVideoById(vid);
        offsetSec = parseTime(document.getElementById('startTimeInput').value);

        const id = url.match(/\/d\/([^\/]+)/)[1];
        const gid = (url.match(/gid=([0-9]+)/) || [null, "0"])[1];
        const csvUrl = `https://docs.google.com/spreadsheets/d/${id}/export?format=csv&gid=${gid}`;

        try {
            const res = await fetch(csvUrl);
            const text = await res.text();
            const rows = text.split(/\r?\n/).map(r => r.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/));
            jobs = rows[24]; icons = rows[25];
            timeline = [];
            for (let i = 30; i < rows.length; i++) {
                const cols = rows[i];
                const sec = parseTime(cols[3]);
                if (sec === null || sec < 0) continue;
                let active = [];
                for (let j = 10; j <= 135; j++) {
                    if (cols[j]?.trim().toUpperCase() === "TRUE") {
                        active.push({ job: jobs[j], icon: icons[j]?.replace(/"/g, "") });
                    }
                }
                timeline.push({ sec, phase: cols[1], gimmick: cols[4], skills: active });
            }
            document.getElementById('status').innerText = "Sync Active";
        } catch (e) { alert("Load Error"); }
    }

    function parseTime(s) {
        if(!s || !s.includes(':')) return null;
        const p = s.trim().split(':').map(Number);
        return p.length === 2 ? p[0]*60+p[1] : p[0]*3600+p[1]*60+p[2];
    }

    function startLoop() {
        if(timer) clearInterval(timer);
        timer = setInterval(() => {
            const time = player.getCurrentTime() - offsetSec;
            const m = Math.floor(Math.max(0,time)/60), s = Math.floor(Math.max(0,time)%60);
            document.getElementById('time-text').innerText = `${m}:${s.toString().padStart(2,'0')}`;
            let cur = null;
            for(let item of timeline) { if(time >= item.sec) cur = item; else break; }
            if(cur) {
                const gEl = document.getElementById('gimmick-text');
                gEl.innerText = cur.gimmick;
                gEl.className = cur.gimmick.includes("スイッチ") ? "gimmick-title switch-yellow" : "gimmick-title";
                document.getElementById('skill-display').innerHTML = cur.skills.map(sk => `
                    <div class="job-card">
                        <span class="job-name">${sk.job || ''}</span>
                        <img src="${sk.icon}" class="skill-icon" onerror="this.style.display='none'">
                    </div>
                `).join('');
            }
        }, 400);
    }
</script>
</body>
</html>